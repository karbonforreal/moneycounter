<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Canna Cabana Money Counter — Enhanced v3 (Direct PDF)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --cabana-red:#D4162B;
      --cabana-amber:#ff9a44;
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#111;
      --muted:#666;
      --border:#e6e8ef;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#1a1f28;
      --card:#252b36;
      --ink:#e8eaed;
      --muted:#9ca3af;
      --border:#3d4451;
      --shadow:0 10px 30px rgba(0,0,0,.7);
    }
    *{box-sizing:border-box}
    html{
      min-height:100vh;
      background:var(--bg);
      transition:background .3s ease;
    }
    body{
      min-height:100vh;
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#f8fafc,#eef2f7 35%,#e9eef6 70%,#f8fafc);
      background-attachment: fixed;
      background-size:200% 200%;
      animation:bgShift 18s ease infinite;
      color:var(--ink);
      position:relative;
      overflow-x:hidden;
      transition:background .3s ease, color .3s ease;
    }
    [data-theme="dark"] body{
      background:linear-gradient(135deg,#141923,#1a1f28 35%,#1f252e 70%,#1a1f28);
      background-attachment: fixed;
      background-size:200% 200%;
    }

    body::before,
    body::after{
      content:"";
      position:fixed;
      inset:auto -160px -260px;
      width:420px;
      height:420px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,rgba(255,154,68,.35),rgba(212,22,43,.12) 55%,transparent 72%);
      filter:blur(0);
      opacity:.75;
      z-index:-1;
      animation:float 26s ease-in-out infinite;
    }

    body::after{
      inset:-260px -140px auto;
      background:radial-gradient(circle at 70% 70%,rgba(25,118,210,.25),rgba(212,22,43,.2) 55%,transparent 72%);
      animation-delay:-8s;
      mix-blend-mode:multiply;
    }
    .wrap{ max-width:560px; margin:18px auto 92px; padding:0 14px 120px; }
    .card{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border); position:relative; animation:cardFloatIn .7s ease both; }
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      pointer-events:none;
      opacity:0;
      background:radial-gradient(circle at top right,rgba(255,154,68,.25),transparent 55%);
      transition:opacity .6s ease;
    }
    .card:hover::after{opacity:1;}
    .header{
      position:relative; padding:18px 16px 20px; color:#fff; text-align:center;
      background:
        radial-gradient(140% 120% at 100% 0%, rgba(255,232,199,.35) 0%, rgba(255,232,199,0) 50%) ,
        linear-gradient(135deg, var(--cabana-red) 0%, var(--cabana-amber) 100%);
      background-size:200% 200%;
      animation:gradientGlow 10s ease infinite;
      isolation:isolate;
    }
    .brand{ display:flex; align-items:center; justify-content:center; gap:12px; }
    .brand img{height:42px; width:auto; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));}
    .brand h1{ margin:0; font-weight:600; font-size:1.2rem; letter-spacing:.3px; text-shadow:0 1px 2px rgba(0,0,0,.25); }
    .content{padding:14px 14px 28px}
    .total-bar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:
        linear-gradient(135deg, rgba(212,22,43,.12), rgba(25,118,210,.08)) border-box,
        var(--card) padding-box;
      border:1px solid transparent;
      border-radius:14px; padding:14px 16px; margin:10px 0 16px;
      box-shadow:0 12px 30px rgba(17,24,39,.12);
      transition: box-shadow .35s ease, transform .35s ease;
    }
    .total-bar.glow{
      box-shadow:0 18px 42px rgba(212,22,43,.28);
      transform:translateY(-2px);
    }
    .total-label{font-weight:600; letter-spacing:.2px}
    .total-amount{font-variant-numeric:tabular-nums; font-size:1.35rem; font-weight:600; position:relative;}
    .total-amount.pulse::after{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius:12px;
      background:radial-gradient(circle, rgba(255,255,255,.55), rgba(255,255,255,0));
      opacity:0;
      animation:totalPulse .6s ease forwards;
    }
    .insights{ display:flex; justify-content:center; gap:12px; margin:12px 0 18px; }
    .insights .insight-card{ max-width:400px; flex:1; }
    .insight-card{
      position:relative;
      background:linear-gradient(135deg,rgba(255,255,255,.92),rgba(248,250,252,.75));
      border:1px solid rgba(230,232,239,.9);
      border-radius:14px;
      padding:12px 14px 14px;
      box-shadow:0 10px 25px rgba(17,24,39,.08);
      overflow:hidden;
      transition:transform .4s ease, box-shadow .4s ease;
      background-size:220% 220%;
      animation:cardSheen 18s ease infinite;
    }
    .insight-card::after{
      content:"";
      position:absolute;
      inset:-40% 30% 60% -30%;
      background:radial-gradient(circle,rgba(255,154,68,.25),transparent 65%);
      opacity:0;
      transition:opacity .4s ease;
    }
    .insight-card:hover{ transform:translateY(-4px) scale(1.01); box-shadow:0 16px 32px rgba(17,24,39,.12); }
    .insight-card:hover::after{opacity:1;}
    [data-theme="dark"] .insight-card{
      background:linear-gradient(135deg,rgba(37,43,54,.98),rgba(45,52,62,.95));
      border:1px solid rgba(61,68,81,.95);
      box-shadow:0 10px 25px rgba(0,0,0,.4);
    }
    [data-theme="dark"] .insight-card:hover{
      box-shadow:0 16px 32px rgba(0,0,0,.6);
    }
    [data-theme="dark"] .card{
      box-shadow:0 10px 40px rgba(0,0,0,.6);
    }
    [data-theme="dark"] .total-bar{
      background:
        linear-gradient(135deg, rgba(212,22,43,.3), rgba(33,150,243,.18)) border-box,
        rgba(37,43,54,.96) padding-box;
      box-shadow:0 12px 36px rgba(0,0,0,.6);
    }
    [data-theme="dark"] .total-bar.glow{
      box-shadow:0 18px 46px rgba(212,22,43,.45);
    }
    .insight-label{font-size:.8rem; letter-spacing:.3px; text-transform:uppercase; color:var(--muted); margin-bottom:6px;}
    .insight-value{font-size:1.35rem; font-weight:600; letter-spacing:.4px; transition:transform .35s ease, color .35s ease;}
    .insight-value.flash{animation:pop .6s ease;}
    .insight-meta{font-size:.75rem; color:var(--muted); margin-top:4px; display:flex; align-items:center; gap:6px; transition: color .35s ease, text-shadow .35s ease;}
    .insight-meta.spark{color:var(--cabana-amber); text-shadow:0 0 10px rgba(255,154,68,.35);}
    .delta{font-weight:600; color:var(--cabana-red); display:inline-flex; align-items:center; gap:4px;}
    .delta.down{color:#1c6dd0;}
    .delta.flash{animation:pop .6s ease;}
    .split-bar{position:relative; height:8px; border-radius:999px; background:rgba(230,232,239,.9); overflow:hidden; margin-top:12px;}
    .split-fill{position:absolute; top:0; bottom:0; transition:width .4s ease;}
    .split-fill.bills{left:0; background:linear-gradient(135deg,rgba(212,22,43,.85),rgba(255,154,68,.85)); box-shadow:0 0 8px rgba(212,22,43,.35);}
    .split-fill.coins{right:0; background:linear-gradient(135deg,rgba(33,150,243,.85),rgba(144,224,239,.85)); box-shadow:0 0 8px rgba(33,150,243,.25);}
    .section{ margin:10px 0 4px; }
    .section h2{
      display:flex; align-items:center; justify-content:space-between;
      margin:.75rem 0 .25rem; font-size:1rem; font-weight:600; color:var(--cabana-red);
      cursor: pointer; user-select: none; padding:8px 6px; border-radius:10px;
      transition: background .2s ease;
    }
    .section h2:hover{ background:rgba(0,0,0,.03); }
    .section h2 .chevron{
      display:inline-block; transition: transform .3s ease;
      margin-right:8px; font-size:0.85rem; color:var(--muted);
    }
    .section h2.collapsed .chevron{ transform: rotate(-90deg); }
    .section-content{
      overflow:hidden; transition: max-height .3s ease, opacity .3s ease;
      max-height: 2000px; opacity:1;
    }
    .section-content.collapsed{
      max-height: 0; opacity:0;
    }
    .subsum{font-variant-numeric:tabular-nums; font-weight:600; color:#222;}
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 10px; border-radius:10px; transition: background .15s ease, transform .2s ease, box-shadow .2s ease, border .2s ease;
      position:relative;
      border: 2px solid transparent;
      animation:fadeInUp .6s ease both;
      animation-delay:var(--delay,0s);
    }
    .row::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(120deg,rgba(212,22,43,.08),rgba(33,150,243,.05));
      opacity:0;
      transition:opacity .2s ease;
      pointer-events:none;
    }
    .row:hover{ background:rgba(0,0,0,.03); transform:translateY(-1px); box-shadow:0 10px 20px rgba(15,23,42,.06); }
    .row.focused::after{opacity:1; animation:pulse 1s ease forwards;}
    .row label{
      flex:1; min-width:120px; display:flex; align-items:center; gap:6px;
    }
    .row .input-group{
      display:flex; align-items:center; gap:6px;
    }
    .row .stepper-btn{
      width:40px; height:40px; border:1px solid var(--border); border-radius:10px;
      background:var(--card); color:var(--ink); font-size:1.3rem; font-weight:600;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition: all .15s ease; user-select:none; -webkit-tap-highlight-color:transparent;
    }
    [data-theme="dark"] .row .stepper-btn{
      background:rgba(30,36,44,.8);
      border:1px solid var(--border);
    }
    .row .stepper-btn:hover{
      background:rgba(212,22,43,.1); border-color:var(--cabana-red);
      transform:scale(1.05);
    }
    [data-theme="dark"] .row .stepper-btn:hover{
      background:rgba(212,22,43,.2);
    }
    .row .stepper-btn:active{
      transform:scale(0.95);
    }
    .row input[type="number"]{
      width:90px; max-width:90px; padding:12px 10px; font-size:1rem; text-align:center;
      border:1px solid var(--border); border-radius:10px; outline:none;
      transition: box-shadow .2s ease, transform .1s ease; -webkit-appearance: none; appearance: textfield;
      background:var(--card); color:var(--ink);
    }
    .row input[type="number"]:focus{ box-shadow:0 0 0 3px rgba(212,22,43,.2); transform:scale(1.02); }
    [data-theme="dark"] .row input[type="number"]{
      border:1px solid var(--border);
      background:rgba(30,36,44,.8);
    }
    .row .subtotal{ width:100px; flex-shrink:0; text-align:right; font-variant-numeric:tabular-nums; color:var(--muted); font-size:0.9rem; }

    /* Sticky bottom action bar */
    .actionbar{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      display:flex; gap:12px; align-items:center; justify-content:center;
      padding:12px 14px; background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
    }
    [data-theme="dark"] .actionbar{
      background:rgba(37,43,54,.95);
    }
    .btn{ padding:14px 16px; border:0; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 6px 16px rgba(0,0,0,.08); min-width:120px; position:relative; overflow:hidden; }
    .btn span{position:relative; z-index:2;}
    .btn::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at var(--x,50%) var(--y,50%),rgba(255,255,255,.45),transparent 60%);
      opacity:0;
      transition:opacity .25s ease;
    }
    .btn:focus-visible{outline:2px solid rgba(255,255,255,.65); outline-offset:2px;}
    .btn:active{ transform: translateY(1px) }
    .btn:active::after{opacity:1;}
    .btn-reset{ background:#2b2b2b; color:#fff;}
    .btn-export{ background:var(--cabana-red); color:#fff;}
    .btn-html{ background:#1c6dd0; color:#fff;}
    .btn-theme{ background:#6b46c1; color:#fff; min-width:56px; padding:14px 12px; font-size:1.2rem; }

    .toast{ position:fixed; left:50%; bottom:76px; transform:translateX(-50%) translateY(20px);
      background:#222; color:#fff; padding:10px 14px; border-radius:10px;
      opacity:0; pointer-events:none; transition: opacity .25s ease, transform .25s ease; z-index:60;}
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    @keyframes bgShift{
      0%,100%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
    }

    @keyframes gradientGlow{
      0%,100%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
    }

    @keyframes float{
      0%,100%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(0,-30px,0) scale(1.05);}
    }

    @keyframes pulse{
      0%{opacity:0;}
      50%{opacity:1;}
      100%{opacity:0;}
    }

    @keyframes pop{
      0%{transform:scale(1);}
      35%{transform:scale(1.08);}
      100%{transform:scale(1);}
    }

    @keyframes totalPulse{
      0%{opacity:0; transform:scale(.85);}
      30%{opacity:1; transform:scale(1.05);}
      100%{opacity:0; transform:scale(1.15);}
    }

    @keyframes fadeInUp{
      0%{opacity:0; transform:translate3d(0,14px,0);}
      100%{opacity:1; transform:translate3d(0,0,0);}
    }

    @keyframes cardSheen{
      0%,100%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
    }

    @keyframes cardFloatIn{
      0%{opacity:0; transform:translate3d(0,18px,0) scale(.98);}
      100%{opacity:1; transform:translate3d(0,0,0) scale(1);}
    }

    @media (max-width:520px){
      .row{ padding:10px 6px; gap:6px; }
      .row label{ min-width:90px; font-size:0.9rem; }
      .row .stepper-btn{ width:36px; height:36px; font-size:1.2rem; }
      .row input[type="number"]{ width:70px; max-width:70px; padding:10px 6px; font-size:0.95rem; }
      .row .subtotal{ width:80px; font-size:0.85rem; }
      .insights{ grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
      .insight-card{ padding:12px; }
      .insight-value{ font-size:1.1rem; }
      .btn{ min-width:46%; padding:14px 10px }
      .actionbar{ gap:8px; }
      .btn-html{ display:none; } /* keep bar tidy on very small screens */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="brand">
          <img id="logo" src="logo.png" alt="Canna Cabana logo">
          <h1>Cabana Money Counter</h1>
        </div>
      </div>

      <div class="content">
        <div class="total-bar" aria-live="polite">
          <div class="total-label">Total</div>
          <div id="grandTotal" class="total-amount">$0.00</div>
        </div>

        <div class="insights" aria-live="polite">
          <div class="insight-card">
            <div class="insight-label">Bills vs coins</div>
            <div class="split-bar">
              <div id="insightSplitBills" class="split-fill bills" style="width:50%"></div>
              <div id="insightSplitCoins" class="split-fill coins" style="width:50%"></div>
            </div>
            <div class="insight-meta" id="insightSplitMeta">50% bills / 50% coins</div>
          </div>
        </div>

        <section class="section">
          <h2><span class="chevron">▼</span><span>Bills</span> <span id="billsTotal" class="subsum">$0.00</span></h2>
          <div class="section-content" id="billsContent">
            <div id="bills"></div>
          </div>
        </section>

        <section class="section">
          <h2><span class="chevron">▼</span><span>Coins</span> <span id="coinsTotal" class="subsum">$0.00</span></h2>
          <div class="section-content" id="coinsContent">
            <div id="coins"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Sticky action bar -->
  <div class="actionbar" role="toolbar" aria-label="Actions">
    <button class="btn btn-theme" id="themeBtn" aria-label="Toggle theme" title="Toggle light/dark mode"><span id="themeIcon">🌙</span></button>
    <button class="btn btn-reset" id="resetBtn"><span>Reset</span></button>
    <button class="btn btn-export" id="exportBtn"><span>Export PDF</span></button>
    <button class="btn btn-html" id="exportHtmlBtn"><span>Export HTML</span></button>
  </div>

  <div id="toast" class="toast">File saved ✅</div>

  <!-- jsPDF + autoTable from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // --- Data ---
    const billDenoms = [
      { label: "$100 bills", v: 10000 },
      { label: "$50 bills",  v: 5000 },
      { label: "$20 bills",  v: 2000 },
      { label: "$10 bills",  v: 1000 },
      { label: "$5 bills",   v: 500  },
    ];
    const coinDenoms = [
      { label: "$2 coins",  v: 200 },
      { label: "$1 coins",  v: 100 },
      { label: "25¢ coins", v: 25  },
      { label: "10¢ coins", v: 10  },
      { label: "5¢ coins",  v: 5   },
    ];

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => n.toLocaleString('en-CA',{style:'currency',currency:'CAD'});
    const logoEl = document.getElementById('logo');

    function triggerAnimation(el, className, duration=600){
      if(!el) return;
      el.classList.remove(className);
      void el.offsetWidth;
      el.classList.add(className);
      setTimeout(() => el.classList.remove(className), duration);
    }

    // Theme toggle
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    const savedTheme = localStorage.getItem('theme') || 'light';

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
      localStorage.setItem('theme', theme);
    }

    setTheme(savedTheme);

    themeBtn.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    const logoToDataUrl = () => {
      try{
        const canvas = document.createElement('canvas');
        canvas.width = logoEl.naturalWidth;
        canvas.height = logoEl.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(logoEl, 0, 0);
        return canvas.toDataURL('image/png');
      }catch(e){
        return null;
      }
    };

    let logoDataUrlPromise;
    function loadLogoDataUrl(){
      if(logoDataUrlPromise){
        return logoDataUrlPromise;
      }

      logoDataUrlPromise = new Promise(resolve => {
        if(!logoEl){
          resolve(null);
          return;
        }

        const resolveWithImage = () => {
          resolve(logoEl.naturalWidth ? logoToDataUrl() : null);
        };

        if(logoEl.complete){
          resolveWithImage();
          return;
        }

        const handleLoad = () => {
          logoEl.removeEventListener('load', handleLoad);
          logoEl.removeEventListener('error', handleError);
          resolveWithImage();
        };
        const handleError = () => {
          logoEl.removeEventListener('load', handleLoad);
          logoEl.removeEventListener('error', handleError);
          resolve(null);
        };

        logoEl.addEventListener('load', handleLoad);
        logoEl.addEventListener('error', handleError);
      });

      return logoDataUrlPromise;
    }

    // Build rows
    function createInputs(list, containerId){
      const cont = document.getElementById(containerId);
      list.forEach(d => {
        const row = document.createElement('div');
        row.className = 'row';
        row.dataset.denom = d.v;
        const delayIndex = cont.children.length;
        row.style.setProperty('--delay', `${delayIndex * 0.04}s`);

        const label = document.createElement('label');
        const labelText = document.createElement('span');
        labelText.textContent = d.label;
        label.appendChild(labelText);

        const minusBtn = document.createElement('button');
        minusBtn.className = 'stepper-btn';
        minusBtn.innerHTML = '−';
        minusBtn.setAttribute('aria-label', 'Decrease');
        minusBtn.type = 'button';

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.inputMode = 'numeric';
        input.dataset.val = d.v;
        input.value = localStorage.getItem('denom-' + d.v) || '0';

        const plusBtn = document.createElement('button');
        plusBtn.className = 'stepper-btn';
        plusBtn.innerHTML = '+';
        plusBtn.setAttribute('aria-label', 'Increase');
        plusBtn.type = 'button';

        // Stepper functionality
        minusBtn.addEventListener('click', () => {
          const current = parseInt(input.value) || 0;
          if(current > 0) {
            input.value = current - 1;
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });

        plusBtn.addEventListener('click', () => {
          const current = parseInt(input.value) || 0;
          input.value = current + 1;
          input.dispatchEvent(new Event('input', { bubbles: true }));
        });

        input.addEventListener('focus', () => {
          if(input.value==='0') input.value='';
          row.classList.add('focused');
        });
        input.addEventListener('blur',  () => {
          if(input.value==='') input.value='0';
          setTimeout(()=>row.classList.remove('focused'), 160);
        });
        input.addEventListener('input', () => {
          row.classList.add('focused');
          setTimeout(()=>row.classList.remove('focused'), 600);
        });

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        inputGroup.append(minusBtn, input, plusBtn);

        const subtotal = document.createElement('div');
        subtotal.className = 'subtotal';
        subtotal.textContent = '= 0.00 CAD';

        row.append(label, inputGroup, subtotal);
        cont.append(row);
      });
    }

    createInputs(billDenoms,'bills');
    createInputs(coinDenoms,'coins');

    // Collapsible sections
    function setupCollapsible(){
      $$('.section h2').forEach(header => {
        header.addEventListener('click', () => {
          const section = header.parentElement;
          const content = section.querySelector('.section-content');
          const chevron = header.querySelector('.chevron');

          header.classList.toggle('collapsed');
          content.classList.toggle('collapsed');

          // Save state
          const sectionId = content.id;
          const isCollapsed = content.classList.contains('collapsed');
          localStorage.setItem('collapsed-' + sectionId, isCollapsed);
        });
      });

      // Restore collapsed state
      $$('.section-content').forEach(content => {
        const isCollapsed = localStorage.getItem('collapsed-' + content.id) === 'true';
        if(isCollapsed){
          const header = content.parentElement.querySelector('h2');
          header.classList.add('collapsed');
          content.classList.add('collapsed');
        }
      });
    }

    setupCollapsible();

    // Animations
    function tweenNumber(el, to, duration=320){
      const from = parseFloat((el.dataset.num || '0'));
      const start = performance.now();
      function frame(t){
        const k = Math.min(1, (t-start)/duration);
        const eased = 1 - Math.pow(1-k, 3);
        const val = from + (to-from)*eased;
        el.textContent = fmt(val);
        el.dataset.num = val.toFixed(2);
        if(k<1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // Sums
    function sumContainer(containerSelector){
      let cents = 0;
      document.querySelectorAll(containerSelector+' input').forEach(i => {
        const count = +i.value || 0;
        const v = +i.dataset.val;
        cents += count * v;
      });
      return cents;
    }

    function updateTotals(){
      const billCents = sumContainer('#bills');
      const coinCents = sumContainer('#coins');
      const totalCents = billCents + coinCents;
      const grand = totalCents / 100;
      tweenNumber($('#billsTotal'), billCents/100);
      tweenNumber($('#coinsTotal'), coinCents/100);
      tweenNumber($('#grandTotal'), grand);
      triggerAnimation($('#grandTotal'), 'pulse');
      triggerAnimation($('.total-bar'), 'glow', 700);

      $$('.row').forEach(r => {
        const i = r.querySelector('input');
        const c = +i.value || 0;
        const v = +i.dataset.val;
        const sub = r.querySelector('.subtotal');
        const each = v / 100;
        const subtotalVal = c * each;
        sub.textContent = '= ' + fmt(subtotalVal);
        localStorage.setItem('denom-'+v, c);
      });

      const splitBillsEl = $('#insightSplitBills');
      const splitCoinsEl = $('#insightSplitCoins');
      const splitMetaEl = $('#insightSplitMeta');

      if(totalCents === 0){
        splitBillsEl.style.width = '50%';
        splitCoinsEl.style.width = '50%';
        splitMetaEl.textContent = '50% bills / 50% coins';
        triggerAnimation(splitMetaEl, 'spark', 500);
      }else{
        const billsPct = (billCents / totalCents) * 100;
        const coinsPct = 100 - billsPct;
        splitBillsEl.style.width = billsPct.toFixed(1) + '%';
        splitCoinsEl.style.width = coinsPct.toFixed(1) + '%';
        splitMetaEl.textContent = `${Math.round(billsPct)}% bills / ${Math.round(coinsPct)}% coins`;
        triggerAnimation(splitMetaEl, 'spark', 700);
      }
    }
    $$('input[type="number"]').forEach(i => i.addEventListener('input', updateTotals));

    updateTotals();

    // Keyboard shortcuts
    const allInputs = $$('input[type="number"]');

    document.addEventListener('keydown', e => {
      // Ctrl+R to reset
      if((e.ctrlKey || e.metaKey) && e.key === 'r'){
        e.preventDefault();
        $('#resetBtn').click();
        return;
      }

      // Ctrl+P to export PDF
      if((e.ctrlKey || e.metaKey) && e.key === 'p'){
        e.preventDefault();
        $('#exportBtn').click();
        return;
      }

      // Enter to move to next field
      if(e.key === 'Enter' && document.activeElement.type === 'number'){
        e.preventDefault();
        const currentIndex = allInputs.indexOf(document.activeElement);
        if(currentIndex > -1 && currentIndex < allInputs.length - 1){
          allInputs[currentIndex + 1].focus();
          allInputs[currentIndex + 1].select();
        }
        return;
      }

      // Arrow up/down and number keys for focused input
      if(document.activeElement.type === 'number'){
        const input = document.activeElement;

        // Arrow up increments
        if(e.key === 'ArrowUp'){
          e.preventDefault();
          const current = parseInt(input.value) || 0;
          input.value = current + 1;
          input.dispatchEvent(new Event('input', { bubbles: true }));
          return;
        }

        // Arrow down decrements
        if(e.key === 'ArrowDown'){
          e.preventDefault();
          const current = parseInt(input.value) || 0;
          if(current > 0){
            input.value = current - 1;
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
          return;
        }

        // Number keys 1-9 to add that amount
        if(/^[1-9]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey){
          // Only if cursor is at the end and field is focused (not typing in middle)
          const cursorAtEnd = input.selectionStart === input.value.length;
          if(cursorAtEnd && input.value === '0'){
            e.preventDefault();
            const current = parseInt(input.value) || 0;
            input.value = current + parseInt(e.key);
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
      }
    });

    // Reset
    $('#resetBtn').addEventListener('click', () => {
      if(!confirm('Reset all values?')) return;
      $$('input[type="number"]').forEach(i => {
        i.value = '0';
        localStorage.removeItem('denom-'+i.dataset.val);
      });
      updateTotals();
    });

    // Button ripple origins
    $$('.btn').forEach(btn => {
      btn.addEventListener('pointerdown', e => {
        const rect = btn.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        btn.style.setProperty('--x', x + '%');
        btn.style.setProperty('--y', y + '%');
      });
    });

    // Export helpers
    function gatherRows(){
      const rows = [];
      $$('.row').forEach(r => {
        const label = r.querySelector('label').textContent;
        const count = +r.querySelector('input').value || 0;
        const each  = +r.querySelector('input').dataset.val / 100;
        if(count>0){
          rows.push({label, count, each, subtotal: +(count*each).toFixed(2)});
        }
      });
      return rows;
    }

    function showToast(msg='File saved ✅'){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1800);
    }

    // Direct PDF via jsPDF
    $('#exportBtn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const date = new Date().toLocaleString('en-CA',{ timeZone:'America/Toronto' });

      const billTotal = parseFloat($('#billsTotal').dataset.num || $('#billsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const coinTotal = parseFloat($('#coinsTotal').dataset.num || $('#coinsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const grand     = parseFloat($('#grandTotal').dataset.num || $('#grandTotal').textContent.replace(/[^0-9.]/g,'')) || 0;

      // Header gradient bar
      doc.setFillColor(212,22,43); // start red
      doc.rect(0,0,595.28,70,'F');
      const logoDataUrl = await loadLogoDataUrl();
      if(logoDataUrl){
        try{
          doc.addImage(logoDataUrl, 'PNG', 24, 18, 36, 36);
        }catch(e){ /* ignore if logo missing */ }
      }

      doc.setFont('helvetica','bold');
      doc.setTextColor(255,255,255);
      doc.setFontSize(14);
      doc.text('Canna Cabana — Money Count', 70, 40);

      doc.setTextColor(30,30,30);
      doc.setFontSize(11);
      doc.text(`Generated: ${date}`, 24, 92);

      // Totals "pills"
      const pill = (x,y,label,val) => {
        doc.setDrawColor(230,232,239);
        doc.setFillColor(255,255,255);
        doc.roundedRect(x,y, 170, 24, 12,12, 'FD');
        doc.setFont('helvetica','bold'); doc.setTextColor(15,15,15);
        doc.text(`${label}: ${fmt(val)}`, x+12, y+16);
      };
      pill(24, 110, 'Bills', billTotal);
      pill(204,110, 'Coins', coinTotal);
      pill(384,110, 'Total', grand);

      // Table
      const body = gatherRows().map(r => [r.label, r.count, fmt(r.each), fmt(r.subtotal)]);
      doc.autoTable({
        head: [['Denomination','Count','Value Each','Subtotal']],
        body,
        startY: 150,
        styles: { font: 'helvetica', fontSize: 11, cellPadding: 6 },
        headStyles: { fillColor: [240,242,246], textColor: [30,30,30], fontStyle:'bold' },
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
        },
        foot: [['', '', 'Grand Total', fmt(grand)]],
        footStyles: { fillColor: [255,255,255], textColor: [20,20,20], fontStyle:'bold' },
        margin: { bottom: 56 } // leave space for footer text
      });

      // Footer note pinned to bottom of page
      const pageHeight = doc.internal.pageSize.getHeight();
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(80,80,80);
      doc.text('Internal use only.', 24, pageHeight - 24);

      const fileName = `canna-${new Date().toLocaleDateString('en-CA').replaceAll('/','-')}.pdf`;
      doc.save(fileName); // triggers a real file download on iPad/iPhone/Mac/Windows
      showToast('PDF saved ✅');
    });

    // HTML report fallback (downloads a .html snapshot)
    $('#exportHtmlBtn').addEventListener('click', async () => {
      const rows = gatherRows();
      const billTotal = parseFloat($('#billsTotal').dataset.num || $('#billsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const coinTotal = parseFloat($('#coinsTotal').dataset.num || $('#coinsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const grand     = parseFloat($('#grandTotal').dataset.num || $('#grandTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const date = new Date().toLocaleString('en-CA');
      const logoDataUrl = await loadLogoDataUrl();
      const inlineLogoSrc = logoDataUrl || (logoEl ? logoEl.getAttribute('src') : null);
      const logoMarkup = inlineLogoSrc ? `<img src="${inlineLogoSrc}" alt="Canna Cabana logo">` : '';
      let html = `<!doctype html><meta charset="utf-8"><title>Cabana Money Count</title>
      <style>
        body{font-family:Montserrat,Arial,sans-serif;padding:16px}
        .head{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#fff;background:linear-gradient(135deg,#D4162B,#ff9a44)}
        .head img{height:36px}
        h1{margin:0;font-size:1.1rem}
        .pill{display:inline-block;margin:8px 8px 0 0;padding:8px 12px;border:1px solid #e6e8ef;border-radius:999px;font-weight:600;background:#fff}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{padding:8px 6px;border-bottom:1px solid #f0f2f6;text-align:left}
        th{border-bottom:2px solid #e6e8ef;color:#444}
        td.right{text-align:right}
        tfoot td{font-weight:700;border-top:2px solid #e6e8ef}
      </style>
      <div class="head">${logoMarkup}<h1>Canna Cabana — Money Count</h1></div>
      <div>Generated: ${date}</div>
      <div class="pill">Bills: ${fmt(billTotal)}</div>
      <div class="pill">Coins: ${fmt(coinTotal)}</div>
      <div class="pill">Total: ${fmt(grand)}</div>
      <table><thead><tr><th>Denomination</th><th class="right">Count</th><th class="right">Value Each</th><th class="right">Subtotal</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        html += `<tr><td>${r.label}</td><td class="right">${r.count}</td><td class="right">${fmt(r.each)}</td><td class="right">${fmt(r.subtotal)}</td></tr>`;
      });
      html += `</tbody><tfoot><tr><td colspan="3" class="right">Grand Total</td><td class="right">${fmt(grand)}</td></tr></tfoot></table>`;
      const blob = new Blob([html],{type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `canna-${new Date().toLocaleDateString('en-CA').replaceAll('/','-')}.html`;
      a.click();
      showToast('HTML saved ✅');
    });
  </script>
</body>
</html>
