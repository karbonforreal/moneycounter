<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Canna Cabana Money Counter — Enhanced v3 (Direct PDF)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --cabana-red:#D4162B;
      --cabana-amber:#ff9a44;
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#111;
      --muted:#666;
      --border:#e6e8ef;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#f8fafc,#eef2f7 35%,#e9eef6 70%,#f8fafc);
      background-attachment: fixed;
      color:var(--ink);
    }
    .wrap{ max-width:560px; margin:18px auto 92px; padding:0 14px 120px; }
    .card{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border); }
    .header{
      position:relative; padding:18px 16px 20px; color:#fff; text-align:center;
      background:
        radial-gradient(140% 120% at 100% 0%, rgba(255,232,199,.35) 0%, rgba(255,232,199,0) 50%) ,
        linear-gradient(135deg, var(--cabana-red) 0%, var(--cabana-amber) 100%);
      isolation:isolate;
    }
    .brand{ display:flex; align-items:center; justify-content:center; gap:12px; }
    .brand img{height:42px; width:auto; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));}
    .brand h1{ margin:0; font-weight:600; font-size:1.2rem; letter-spacing:.3px; text-shadow:0 1px 2px rgba(0,0,0,.25); }
    .content{padding:14px}
    .total-bar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:var(--card); border: 1px solid var(--border);
      border-radius:12px; padding:10px 12px; margin:10px 0 12px;
    }
    .total-label{font-weight:600; letter-spacing:.2px}
    .total-amount{font-variant-numeric:tabular-nums; font-size:1.25rem; font-weight:600}
    .section{ margin:10px 0 4px; }
    .section h2{
      display:flex; align-items:center; justify-content:space-between;
      margin:.75rem 0 .25rem; font-size:1rem; font-weight:600; color:var(--cabana-red);
    }
    .subsum{font-variant-numeric:tabular-nums; font-weight:600; color:#222;}
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 10px; border-radius:10px; transition: background .15s ease;
    }
    .row:hover{ background:rgba(0,0,0,.03); }
    .row label{ flex:1; min-width:140px }
    .row input[type="number"]{
      width:110px; max-width:110px; padding:12px 10px; font-size:1rem; text-align:right;
      border:1px solid var(--border); border-radius:10px; outline:none;
      transition: box-shadow .2s ease, transform .1s ease; -webkit-appearance: none; appearance: textfield;
    }
    .row input[type="number"]:focus{ box-shadow:0 0 0 3px rgba(212,22,43,.2); transform:scale(1.02); }
    .row .subtotal{ width:120px; flex-shrink:0; text-align:right; font-variant-numeric:tabular-nums; color:var(--muted); }

    /* Sticky bottom action bar */
    .actionbar{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      display:flex; gap:12px; align-items:center; justify-content:center;
      padding:12px 14px; background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
    }
    .btn{ padding:14px 16px; border:0; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 6px 16px rgba(0,0,0,.08); min-width:120px; }
    .btn:active{ transform: translateY(1px) }
    .btn-reset{ background:#2b2b2b; color:#fff;}
    .btn-export{ background:var(--cabana-red); color:#fff;}
    .btn-html{ background:#1c6dd0; color:#fff;}

    .toast{ position:fixed; left:50%; bottom:76px; transform:translateX(-50%) translateY(20px);
      background:#222; color:#fff; padding:10px 14px; border-radius:10px;
      opacity:0; pointer-events:none; transition: opacity .25s ease, transform .25s ease; z-index:60;}
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    @media (max-width:420px){
      .row{ padding:10px 8px }
      .row label{ min-width:120px }
      .row input[type="number"]{ width:96px; max-width:96px; padding:12px 8px }
      .row .subtotal{ width:96px }
      .btn{ min-width:46%; padding:14px 10px }
      .actionbar{ gap:8px; }
      .btn-html{ display:none; } /* keep bar tidy on very small screens */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="brand">
          <img id="logo" alt="Canna Cabana logo">
          <h1>Cabana Money Counter</h1>
        </div>
      </div>

      <div class="content">
        <div class="total-bar" aria-live="polite">
          <div class="total-label">Total</div>
          <div id="grandTotal" class="total-amount">$0.00</div>
        </div>

        <section class="section">
          <h2>Bills <span id="billsTotal" class="subsum">$0.00</span></h2>
          <div id="bills"></div>
        </section>

        <section class="section">
          <h2>Coins <span id="coinsTotal" class="subsum">$0.00</span></h2>
          <div id="coins"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Sticky action bar -->
  <div class="actionbar" role="toolbar" aria-label="Actions">
    <button class="btn btn-reset" id="resetBtn">Reset</button>
    <button class="btn btn-export" id="exportBtn">Export PDF</button>
    <button class="btn btn-html" id="exportHtmlBtn">Export HTML</button>
  </div>

  <div id="toast" class="toast">File saved ✅</div>

  <!-- jsPDF + autoTable from CDN -->
  <script src="logo-data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // --- Data ---
    const billDenoms = [
      { label: "$100 bills", v: 10000 },
      { label: "$50 bills",  v: 5000 },
      { label: "$20 bills",  v: 2000 },
      { label: "$10 bills",  v: 1000 },
      { label: "$5 bills",   v: 500  },
    ];
    const coinDenoms = [
      { label: "$2 coins",  v: 200 },
      { label: "$1 coins",  v: 100 },
      { label: "25¢ coins", v: 25  },
      { label: "10¢ coins", v: 10  },
      { label: "5¢ coins",  v: 5   },
    ];

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => n.toLocaleString('en-CA',{style:'currency',currency:'CAD'});
    const logoDataUrl = typeof LOGO_DATA_URL !== 'undefined' ? LOGO_DATA_URL : null;
    const logoEl = document.getElementById('logo');
    if(logoDataUrl && logoEl){
      logoEl.src = logoDataUrl;
    }

    // Build rows
    function createInputs(list, containerId){
      const cont = document.getElementById(containerId);
      list.forEach(d => {
        const row = document.createElement('div');
        row.className = 'row';

        const label = document.createElement('label');
        label.textContent = d.label;

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.inputMode = 'numeric';
        input.dataset.val = d.v;
        input.value = localStorage.getItem('denom-' + d.v) || '0';
        input.addEventListener('focus', () => { if(input.value==='0') input.value=''; });
        input.addEventListener('blur',  () => { if(input.value==='') input.value='0'; });

        const subtotal = document.createElement('div');
        subtotal.className = 'subtotal';
        subtotal.textContent = '= 0.00 CAD';

        row.append(label, input, subtotal);
        cont.append(row);
      });
    }
    createInputs(billDenoms,'bills');
    createInputs(coinDenoms,'coins');

    // Animations
    function tweenNumber(el, to, duration=320){
      const from = parseFloat((el.dataset.num || '0'));
      const start = performance.now();
      function frame(t){
        const k = Math.min(1, (t-start)/duration);
        const eased = 1 - Math.pow(1-k, 3);
        const val = from + (to-from)*eased;
        el.textContent = fmt(val);
        el.dataset.num = val.toFixed(2);
        if(k<1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // Sums
    function sumContainer(containerSelector){
      let cents = 0;
      document.querySelectorAll(containerSelector+' input').forEach(i => {
        const count = +i.value || 0;
        const v = +i.dataset.val;
        cents += count * v;
      });
      return cents;
    }

    function updateTotals(){
      let billCents = sumContainer('#bills');
      let coinCents = sumContainer('#coins');
      let grand = (billCents + coinCents)/100;
      tweenNumber($('#billsTotal'), billCents/100);
      tweenNumber($('#coinsTotal'), coinCents/100);
      tweenNumber($('#grandTotal'), grand);

      $$('.row').forEach(r => {
        const i = r.querySelector('input');
        const c = +i.value || 0;
        const v = +i.dataset.val;
        const sub = r.querySelector('.subtotal');
        sub.textContent = '= ' + (c*v/100).toFixed(2) + ' CAD';
        localStorage.setItem('denom-'+v, c);
      });
    }
    $$('input[type="number"]').forEach(i => i.addEventListener('input', updateTotals));
    updateTotals();

    // Reset
    $('#resetBtn').addEventListener('click', () => {
      if(!confirm('Reset all values?')) return;
      $$('input[type="number"]').forEach(i => {
        i.value = '0';
        localStorage.removeItem('denom-'+i.dataset.val);
      });
      updateTotals();
    });

    // Export helpers
    function gatherRows(){
      const rows = [];
      $$('.row').forEach(r => {
        const label = r.querySelector('label').textContent;
        const count = +r.querySelector('input').value || 0;
        const each  = +r.querySelector('input').dataset.val / 100;
        if(count>0){
          rows.push({label, count, each, subtotal: +(count*each).toFixed(2)});
        }
      });
      return rows;
    }

    function showToast(msg='File saved ✅'){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1800);
    }

    // Direct PDF via jsPDF
    $('#exportBtn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const date = new Date().toLocaleString('en-CA',{ timeZone:'America/Toronto' });

      const billTotal = parseFloat($('#billsTotal').dataset.num || $('#billsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const coinTotal = parseFloat($('#coinsTotal').dataset.num || $('#coinsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const grand     = parseFloat($('#grandTotal').dataset.num || $('#grandTotal').textContent.replace(/[^0-9.]/g,'')) || 0;

      // Header gradient bar
      doc.setFillColor(212,22,43); // start red
      doc.rect(0,0,595.28,70,'F');
      if(logoDataUrl){
        try{
          doc.addImage(logoDataUrl, 'PNG', 24, 18, 36, 36);
        }catch(e){ /* ignore if logo missing */ }
      }

      doc.setFont('helvetica','bold');
      doc.setTextColor(255,255,255);
      doc.setFontSize(14);
      doc.text('Canna Cabana — Money Count', 70, 40);

      doc.setTextColor(30,30,30);
      doc.setFontSize(11);
      doc.text(`Generated: ${date}`, 24, 92);

      // Totals "pills"
      const pill = (x,y,label,val) => {
        doc.setDrawColor(230,232,239);
        doc.setFillColor(255,255,255);
        doc.roundedRect(x,y, 170, 24, 12,12, 'FD');
        doc.setFont('helvetica','bold'); doc.setTextColor(15,15,15);
        doc.text(`${label}: ${fmt(val)}`, x+12, y+16);
      };
      pill(24, 110, 'Bills', billTotal);
      pill(204,110, 'Coins', coinTotal);
      pill(384,110, 'Total', grand);

      // Table
      const body = gatherRows().map(r => [r.label, r.count, fmt(r.each), fmt(r.subtotal)]);
      doc.autoTable({
        head: [['Denomination','Count','Value Each','Subtotal']],
        body,
        startY: 150,
        styles: { font: 'helvetica', fontSize: 11, cellPadding: 6 },
        headStyles: { fillColor: [240,242,246], textColor: [30,30,30], fontStyle:'bold' },
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
        },
        foot: [['', '', 'Grand Total', fmt(grand)]],
        footStyles: { fillColor: [255,255,255], textColor: [20,20,20], fontStyle:'bold' },
        margin: { bottom: 56 } // leave space for footer text
      });

      // Footer note pinned to bottom of page
      const pageHeight = doc.internal.pageSize.getHeight();
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(80,80,80);
      doc.text('Internal use only.', 24, pageHeight - 24);

      const fileName = `canna-${new Date().toLocaleDateString('en-CA').replaceAll('/','-')}.pdf`;
      doc.save(fileName); // triggers a real file download on iPad/iPhone/Mac/Windows
      showToast('PDF saved ✅');
    });

    // HTML report fallback (downloads a .html snapshot)
    $('#exportHtmlBtn').addEventListener('click', () => {
      const rows = gatherRows();
      const billTotal = parseFloat($('#billsTotal').dataset.num || $('#billsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const coinTotal = parseFloat($('#coinsTotal').dataset.num || $('#coinsTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const grand     = parseFloat($('#grandTotal').dataset.num || $('#grandTotal').textContent.replace(/[^0-9.]/g,'')) || 0;
      const date = new Date().toLocaleString('en-CA');
      let html = `<!doctype html><meta charset="utf-8"><title>Cabana Money Count</title>
      <style>
        body{font-family:Montserrat,Arial,sans-serif;padding:16px}
        .head{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#fff;background:linear-gradient(135deg,#D4162B,#ff9a44)}
        .head img{height:36px}
        h1{margin:0;font-size:1.1rem}
        .pill{display:inline-block;margin:8px 8px 0 0;padding:8px 12px;border:1px solid #e6e8ef;border-radius:999px;font-weight:600;background:#fff}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{padding:8px 6px;border-bottom:1px solid #f0f2f6;text-align:left}
        th{border-bottom:2px solid #e6e8ef;color:#444}
        td.right{text-align:right}
        tfoot td{font-weight:700;border-top:2px solid #e6e8ef}
      </style>
      <div class="head">${logoDataUrl ? `<img src=\"${logoDataUrl}\" alt=\"Canna Cabana logo\">` : ''}<h1>Canna Cabana — Money Count</h1></div>
      <div>Generated: ${date}</div>
      <div class="pill">Bills: ${fmt(billTotal)}</div>
      <div class="pill">Coins: ${fmt(coinTotal)}</div>
      <div class="pill">Total: ${fmt(grand)}</div>
      <table><thead><tr><th>Denomination</th><th class="right">Count</th><th class="right">Value Each</th><th class="right">Subtotal</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        html += `<tr><td>${r.label}</td><td class="right">${r.count}</td><td class="right">${fmt(r.each)}</td><td class="right">${fmt(r.subtotal)}</td></tr>`;
      });
      html += `</tbody><tfoot><tr><td colspan="3" class="right">Grand Total</td><td class="right">${fmt(grand)}</td></tr></tfoot></table>`;
      const blob = new Blob([html],{type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `canna-${new Date().toLocaleDateString('en-CA').replaceAll('/','-')}.html`;
      a.click();
      showToast('HTML saved ✅');
    });
  </script>
</body>
</html>
